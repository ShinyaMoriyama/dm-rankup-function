# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

炭酸水メーカーのガスシリンダー交換におけるランクアッププログラムの計算システムをDartで実装したモジュールです。交換履歴に基づいてポイント、ランク、ボーナスを計算します。

## コマンド

### テストの実行
```bash
dart test_rank_calculator.dart
```

### 特定のテストケースの実行
テストファイルは単純なmain()関数を使用しているため、特定のテストケースを実行するには`test_rank_calculator.dart`内の他のテストをコメントアウトしてください。

## ランクシステム仕様

### ランクシステムの基本仕様

1. **ランク範囲**: 0～5（最大ランク5）
2. **ランクアップ条件**:
   - ランク0: 12回交換で次ランクへ
   - ランク1以上: 24回交換で次ランクへ
3. **初期状態**: ランク0、交換回数0から開始

### ポイントシステム

1. **基本ポイント**（交換の都度獲得）:
   - ランク0: 50ポイント
   - ランク1: 60ポイント
   - ランク2: 70ポイント
   - ランク3: 80ポイント
   - ランク4: 100ポイント
   - ランク5: 200ポイント

2. **ランクアップボーナス**（ランクアップ時のみ）:
   - ランク1到達時: 200ポイント
   - ランク2到達時: 500ポイント
   - ランク3到達時: 700ポイント
   - ランク4到達時: 1000ポイント
   - ランク5到達時: 2000ポイント

### ランクダウン仕様

1. **条件**: 180日間交換がない場合（181日目以降にランクダウン）
2. **影響**:
   - 1ランクダウン
   - 交換回数リセット（0回に）
   - 再度ランクアップしてもボーナスなし（同ランクのボーナスは一度限り）
3. **日付計算の仕様**:
   - 時刻に関係なく日付のみで判定（時刻を00:00:00に正規化）
   - 当日: 0日経過
   - 前日: 1日経過
   - 前々日: 2日経過
   - 180日目: まだランクダウンしない
   - 181日目: ランクダウン発生
   - 例: 1/1 23:59 → 1/2 00:01 = 1日経過として計算

## アーキテクチャ

### 主要コンポーネント

1. **データモデル** (`rank_point_struct.dart`)
   - 計算結果を表す14個のフィールドを持つイミュータブルなデータ構造
   - すべてのフィールドはnullable（`int?`）で様々な状態に対応
   - 交換前後の状態を完全に保持（残りポイント、残り交換回数、必要総交換回数）
   - 交換後のフィールドには`AfterExchange`接尾語を使用

2. **ビジネスロジック** (`rank_calculator.dart`)
   - すべての計算を処理する単一の純粋関数 `calculateRankPoint()`
   - 定数マップ `basePointsByRank` と `rankUpBonuses` で設定を管理

### 関数パラメータ

`calculateRankPoint()`関数は以下を受け取ります：
- `currentRank`: 現在のランク（0-5）
- `currentExchangeCount`: 現在のランクでの交換完了回数
- `lastPointAcquiredDate`: 最後の交換日（ランクダウン計算用）
- `highestBonusReceivedRank`: ボーナスを受け取った最高ランク
- `currentTotalPoints`: これまでの累計獲得ポイント

### テスト戦略

テストファイルでは以下を検証：
- 初期状態の処理（nullパラメータ）
- ランク昇格シナリオ
- 180日間の非活動後のランクダウン
- ボーナスポイント割り当てルール
- 最大ランクの動作
- 累計ポイント計算

## 開発上の注意点

- より大きな`app-drink-mate`プロジェクトの一部と思われるスタンドアロンモジュール
- このディレクトリにはパッケージ管理ファイルが存在しない
- Dartのnull安全機能を広範囲に使用
- 180日ルールはJST（日本標準時）で計算される